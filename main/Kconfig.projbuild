menu "IAQ Monitor Configuration"

    config IAQ_WIFI_SSID
        string "WiFi SSID"
        default ""
        help
            SSID of the WiFi network to connect to.
            Leave empty to start in SoftAP provisioning mode on first boot
            (or when credentials are not present in NVS).

    config IAQ_WIFI_PASSWORD
        string "WiFi Password"
        default ""
        help
            WiFi password for the network.
            Leave empty if not pre-provisioning via menuconfig. You can always
            set credentials later using the web UI or console.

    config IAQ_MQTT_BROKER_URL
        string "MQTT Broker URL"
        default "mqtt://192.168.1.100:1883"
        help
            URL of the MQTT broker. Examples:
            mqtt://broker.local:1883
            mqtts://broker.local:8883

    config IAQ_MQTT_USERNAME
        string "MQTT Username"
        default ""
        help
            Username for MQTT authentication (leave empty if not required)

    config IAQ_MQTT_PASSWORD
        string "MQTT Password"
        default ""
        help
            Password for MQTT authentication (leave empty if not required)

    config IAQ_DEVICE_ID
        string "Device ID"
        default "iaq_livingroom"
        help
            Unique identifier for this device. Used in MQTT topics.

    config IAQ_MQTT_CRITICAL_QOS
        int "MQTT Critical Messages QoS Level"
        default 1
        range 0 2
        help
            QoS for critical, non-periodic messages (status LWT, HA discovery).
            Recommended: 1 (At least once) - ensures delivery of important state changes.

    config IAQ_MQTT_TELEMETRY_QOS
        int "MQTT Telemetry QoS Level"
        default 0
        range 0 2
        help
            QoS for periodic telemetry topics (/health, /state, /metrics, /diagnostics).
            These are published every 30-300 seconds and are idempotent.
            Recommended: 0 (At most once) - prevents outbox congestion, missing one
            message is acceptable since the next one arrives soon.

            Using QoS 1 for high-frequency telemetry can cause MQTT outbox buildup
            and block the publish worker after hours of operation.

    config IAQ_STATUS_LED_GPIO
        int "Status LED GPIO number"
        default 48
        help
            GPIO number for status LED (RGB LED data pin for WS2812)

    config IAQ_ENABLE_CONSOLE_COMMANDS
        bool "Enable console commands"
        default y
        help
            Enable runtime console commands for configuration and debugging

    config IAQ_PM_RUNTIME_ENABLE
        bool "Enable runtime power management (DFS + light sleep)"
        default y
        depends on PM_ENABLE
        help
            When enabled, pm_guard configures dynamic frequency scaling and light sleep
            locks at startup. Disable to compare power consumption without runtime PM
            while keeping PM support compiled in.


    menu "Wi-Fi AP Provisioning"
        config IAQ_AP_SSID
            string "SoftAP SSID (provisioning)"
            default "IAQ-Setup"
            help
                SSID used when device starts in SoftAP mode for provisioning.

        config IAQ_AP_PASSWORD
            string "SoftAP Password (empty = open)"
            default ""
        help
            Password for the provisioning SoftAP. Leave empty to run an open AP.
            If set but shorter than 8 characters, the firmware will warn at
            startup and start the AP in OPEN mode for compatibility.

        config IAQ_AP_CHANNEL
            int "SoftAP Channel"
            range 1 13
            default 1
            help
                Wi-Fi channel for SoftAP mode.

        config IAQ_AP_MAX_CONN
            int "SoftAP max stations"
            range 1 10
            default 4
            help
                Maximum number of stations allowed to connect to the SoftAP.

        config IAQ_WIFI_CONNECT_MAX_RETRY
            int "Max STA retries before AP fallback"
            range 0 100
            default 10
            help
                Number of reconnect attempts in STA mode before falling back to SoftAP
                (provisioning) mode.

        config IAQ_AP_KEEP_AFTER_PROVISION
            bool "Keep SoftAP active after STA connects (AP+STA)"
            default n
            help
                When enabled, device runs in AP+STA after credentials are provisioned, so the
                web UI can always be reached via SoftAP and LAN simultaneously. By default we
                switch to STA-only after provisioning.
    endmenu

    menu "Wi-Fi Power Save"
        choice IAQ_WIFI_PS_MODE
            prompt "Wi-Fi power save mode (station)"
            default IAQ_WIFI_PS_MODEM_MIN
            depends on IAQ_PM_RUNTIME_ENABLE
            help
                Wi-Fi power save mode for station operation. Modem sleep reduces APB lock
                time and power draw. Choose NONE if you need lowest latency.
            config IAQ_WIFI_PS_NONE
                bool "None"
            config IAQ_WIFI_PS_MODEM_MIN
                bool "Modem sleep (min)"
            config IAQ_WIFI_PS_MODEM_MAX
                bool "Modem sleep (max)"
        endchoice

        config IAQ_WIFI_LISTEN_INTERVAL
            int "Listen interval (DTIMs) for station power save"
            range 1 10
            default 3
            depends on IAQ_WIFI_PS_MODEM_MIN || IAQ_WIFI_PS_MODEM_MAX
            help
                DTIM listen interval used in STA mode. Takes effect when modem sleep is enabled.
    endmenu

    menu "MQTT Publishing Options"
        config MQTT_STATE_PUBLISH_INTERVAL_SEC
            int "State publish interval (seconds)"
            default 30
            range 5 300
            help
                How often to publish compensated sensor data to /state topic.
                This is the primary telemetry topic with fused (compensated) values.
                Default: 30 seconds.

        config MQTT_METRICS_PUBLISH_INTERVAL_SEC
            int "Metrics publish interval (seconds)"
            default 30
            range 5 300
            help
                How often to publish derived metrics to /metrics topic.
                Includes AQI breakdown, comfort details, trends, and scores.
                Default: 30 seconds.

        config MQTT_PUBLISH_DIAGNOSTICS
            bool "Publish diagnostics topic"
            default n
            help
                Publish detailed diagnostics to iaq/{device}/diagnostics topic.
                Includes raw sensor values, fusion corrections, and ABC state.
                Published at lower rate (5 min) to reduce bandwidth.
                Useful for validation and tuning, not needed for normal operation.

        config MQTT_DIAGNOSTICS_PUBLISH_INTERVAL_SEC
            int "Diagnostics publish interval (seconds)"
            default 300
            range 60 3600
            depends on MQTT_PUBLISH_DIAGNOSTICS
            help
                How often to publish diagnostics data.
                Default: 300 seconds (5 minutes).

        config MQTT_PUBLISH_PM1
            bool "Create Home Assistant entity for PM1.0"
            default n
            help
                Publish PM1.0 to HA auto-discovery.
                Most users only need PM2.5/PM10 for AQI.
                PM1.0 is still collected and included in diagnostics.
                Enable for advanced monitoring or sensor validation.

endmenu

menu "MQTT TLS"
    config IAQ_MQTT_TLS_SKIP_COMMON_NAME_CHECK
        bool "Skip TLS common name (CN) check"
        default n
        help
            When using MQTTS with an IP address or when the certificate CN/SAN
            does not match the hostname, enable this to skip the CN check.
            Not recommended for production; prefer matching hostnames.

    choice IAQ_MQTT_TLS_TRUST_MODE
        prompt "TLS trust source"
        default IAQ_MQTT_TLS_TRUST_BUNDLE
        help
            Select how the device verifies the broker's server certificate when
            connecting to mqtts:// URLs.

        config IAQ_MQTT_TLS_TRUST_BUNDLE
            bool "Certificate bundle (recommended)"
            help
                Use ESP-IDF's built-in certificate bundle to validate public CAs
                (e.g., Let's Encrypt). Enable CONFIG_MBEDTLS_CERTIFICATE_BUNDLE.

        config IAQ_MQTT_TLS_TRUST_CA_PEM
            bool "Embed custom Root CA PEM"
            help
                Embed a custom Root CA PEM at build time. Place the file at
                components/connectivity/certs/ca.pem.

        config IAQ_MQTT_TLS_TRUST_INSECURE
            bool "Insecure (no server verification)"
            help
                Do not verify the broker's certificate. This is insecure and
                should only be used for local testing with self-signed certs.
                Consider using a proper Root CA instead.
    endchoice

    config IAQ_MQTT_MTLS_ENABLE
        bool "Enable mutual TLS (client certificate)"
        default n
        help
            Enable client certificate authentication. Place client cert and key
            files at components/connectivity/certs/client.crt.pem and
            components/connectivity/certs/client.key.pem.

    config IAQ_MQTT_TLS_AWS_IOT_ALPN
        bool "Use AWS IoT ALPN (port 443)"
        default n
        help
            Attach ALPN protocol x-amzn-mqtt-ca for AWS IoT Core over port 443.
            Use with mqtts://<endpoint>:443. Leave disabled for port 8883.
endmenu

menu "Time Synchronization"
    config IAQ_TZ_STRING
        string "Time zone (POSIX TZ string)"
        default "CET-1CEST,M3.5.0/2,M10.5.0/3"
        help
            POSIX TZ string for local time. Default is Central European Time
            with daylight saving for Czech Republic: CET (UTC+1) and CEST
            from last Sunday in March 02:00 to last Sunday in October 03:00.
            Example alternatives: "UTC" or other POSIX TZ strings.
            Used to format localtime and determine day/night windows.

    config IAQ_NTP_SERVER0
        string "Primary NTP server"
        default "time.google.com"
        help
            Hostname of the primary NTP server.

    config IAQ_NTP_SERVER1
        string "Secondary NTP server"
        default "pool.ntp.org"
        help
            Hostname of a secondary NTP server (optional).
endmenu

menu "Profiling"
    config IAQ_PROFILING
        bool "Enable profiling and extended status reporting"
        default n
        help
            Enable low-overhead profiling of key operations and enhanced
            system status report. When disabled, reporting falls back to a
            single concise status line.

    config IAQ_PROFILING_INTERVAL_SEC
        int "Profiling report interval (seconds)"
        default 30
        range 5 600
        depends on IAQ_PROFILING
        help
            How often to print and reset profiling statistics.

    config IAQ_PROFILING_TASK_STACKS
        bool "Include task stack high-water marks in report"
        default y
        depends on IAQ_PROFILING
        help
            Report FreeRTOS task stack headroom (bytes) for registered tasks.

    config IAQ_PROFILING_RUNTIME_STATS
        bool "Include CPU runtime stats per task"
        default n
        depends on IAQ_PROFILING
        select FREERTOS_USE_TRACE_FACILITY
        select FREERTOS_GENERATE_RUN_TIME_STATS
        select FREERTOS_USE_STATS_FORMATTING_FUNCTIONS
        help
            Adds CPU usage breakdown per task using FreeRTOS runtime stats.
            Increases code size modestly.

    config IAQ_PROFILING_PM_LOCKS
        bool "Include PM lock profiling (esp_pm_dump_locks)"
        default n
        depends on IAQ_PROFILING && PM_ENABLE
        select PM_PROFILING
        help
            Track time each PM lock is held and allow dumping via esp_pm_dump_locks().
            Adds runtime overhead; keep disabled in production.

    config IAQ_PROFILING_PARSEABLE_OUTPUT
        bool "Use machine-parseable output format"
        default n
        depends on IAQ_PROFILING
        help
            Emit simplified parseable lines instead of human-friendly formatting.
            Useful for scraping logs; off by default.
            Note: Reserved for future use; currently not used.
endmenu

endmenu
